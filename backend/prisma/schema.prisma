generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public"]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model ChatMessage {
  history         Json         @db.Json
  messages        Json[]       @db.Json
  conversation_id String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  created_at      DateTime     @default(now())
  Conversation    Conversation @relation(fields: [conversation_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "ChatMessage_conversationId_fkey")

  @@schema("public")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Conversation {
  title            String
  created_at       DateTime     @default(now())
  owner_guest_id   String?      @db.Uuid
  owner_profile_id String?      @db.Uuid
  id               String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ChatMessage      ChatMessage?
  Guest            Guest?       @relation(fields: [owner_guest_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Profile          Profile?     @relation(fields: [owner_profile_id], references: [id], map: "Conversation_userId_fkey")

  @@schema("public")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Profile {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email           String?           @unique
  display_name    String?
  created_at      DateTime          @default(now())
  updated_at      DateTime?
  avatar_url      String?
  Conversation    Conversation[]
  Guest           Guest[]
  GuestConversion GuestConversion[]
  SavedRecipe     SavedRecipe[]
  RecipeHistory   RecipeHistory[]

  @@schema("public")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Guest {
  id                   String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  created_at           DateTime          @default(now()) @db.Timestamptz(6)
  converted_to_profile Boolean           @default(false)
  converted_user_id    String?           @db.Uuid
  converted_at         DateTime?         @db.Timestamptz(6)
  conversion_token     String            @default(dbgenerated("gen_random_uuid()"))
  Conversation         Conversation[]
  Profile              Profile?          @relation(fields: [converted_user_id], references: [id])
  GuestConversion      GuestConversion[]
  SavedRecipe          SavedRecipe[]
  RecipeHistory        RecipeHistory[]

  @@schema("public")
}

// Constrain mealSlot values
enum MealSlot {
  breakfast
  lunch
  dinner
  snack

  @@schema("public")
}

// Optional: constrain how the plan was created
enum GenerationMethod {
  manual
  ai_generated
  ai_assisted

  @@schema("public")
}

model MealPlan {
  id               String            @id @default(uuid()) @db.Uuid
  userId           String            @map("user_id") @db.Uuid // logical ref to auth.users; no DB FK
  weekStartDate    DateTime          @map("week_start_date") @db.Date // store "date" only
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  title            String?
  generationPrompt String?           @map("generation_prompt") @db.Text
  generationMethod GenerationMethod? @map("generation_method")
  aiPreferences    Json?             @map("ai_preferences")

  // Relations
  items MealPlanItem[]

  // Useful for queries like "get this user's plan for week X"
  @@index([userId, weekStartDate], map: "meal_plans_user_week_idx")
  @@schema("public")
}

model MealPlanItem {
  id         String   @id @default(uuid()) @db.Uuid
  mealPlanId String   @map("meal_plan_id") @db.Uuid
  day        Int // 0..6 (Sun..Sat)
  mealSlot   MealSlot @map("meal_slot")
  recipeId   String?  @map("recipe_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  mealPlan MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  // If you have a Recipe model in public schema, you can add:
  // recipe     Recipe?  @relation(fields: [recipeId], references: [id])

  // One row per (plan, day, meal)
  @@unique([mealPlanId, day, mealSlot], map: "meal_plan_day_slot_unique")
  @@index([mealPlanId], map: "meal_plan_items_plan_idx")
  @@check("day_range_check", map: "meal_plan_items_day_check", [day >= 0 && day <= 6])
  @@schema("public")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model GuestConversion {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  guest_id          String   @db.Uuid
  converted_user_id String   @db.Uuid
  converted_at      DateTime @default(now()) @db.Timestamptz(6)
  ip_address        String?
  user_agent        String?
  Profile           Profile  @relation(fields: [converted_user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Guest             Guest    @relation(fields: [guest_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@schema("public")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Recipe {
  id            String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title         String
  content_json  Json            @db.Json
  nutrition     Json?           @db.Json
  tags          String[]
  created_at    DateTime        @default(now())
  SavedRecipe   SavedRecipe[]
  RecipeHistory RecipeHistory[]

  @@schema("public")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model SavedRecipe {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  owner_profile_id String?  @db.Uuid
  owner_guest_id   String?  @db.Uuid
  recipe_id        String   @db.Uuid
  created_at       DateTime @default(now())
  Recipe           Recipe   @relation(fields: [recipe_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  Profile          Profile? @relation(fields: [owner_profile_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Guest            Guest?   @relation(fields: [owner_guest_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([owner_profile_id, recipe_id])
  @@unique([owner_guest_id, recipe_id])
  @@schema("public")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model RecipeHistory {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  owner_profile_id String?  @db.Uuid
  owner_guest_id   String?  @db.Uuid
  recipe_id        String   @db.Uuid
  created_at       DateTime @default(now())
  Recipe           Recipe   @relation(fields: [recipe_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  Profile          Profile? @relation(fields: [owner_profile_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  Guest            Guest?   @relation(fields: [owner_guest_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([owner_profile_id, recipe_id])
  @@unique([owner_guest_id, recipe_id])
  @@schema("public")
}
